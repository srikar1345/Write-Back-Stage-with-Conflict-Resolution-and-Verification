`timescale 1ns / 1ps
//////////////////////////////////////////////////////////////////////////////////
// Company: 
// Engineer: 
// 
// Create Date: 11/18/2025 12:44:38 AM
// Design Name: 
// Module Name: tg
// Project Name: 
// Target Devices: 
// Tool Versions: 
// Description: 
// 
// Dependencies: 
// 
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
// 
//////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////
// Company: 
// Engineer: 
// 
// Create Date: 11/18/2025 12:44:38 AM
// Design Name: 
// Module Name: tg
// Project Name: 
// Target Devices: 
// Tool Versions: 
// Description: 
// 
// Dependencies: 
// 
// Revision:
// Revision 0.01 - File Created
// Additional Comments:
// 
//////////////////////////////////////////////////////////////////////////////////


`timescale 1ns/1ps

module WriteBackSubsystem_tb;

    // ----------------------------
    // DUT Inputs / Outputs
    // ----------------------------
    reg clk;
    reg rst_n;

    reg  [4:0] ra1_tb, ra2_tb;
    wire [31:0] rd1_o_tb, rd2_o_tb;

    reg issue_tb;
    reg [4:0] wa_arch_dispatch_tb;
    wire [4:0] rob_id_o_tb;
    wire issue_ready_o_tb;

    reg complete_ooc_tb;
    reg [4:0] rob_id_complete_tb;
    reg [31:0] result_complete_tb;

    reg stall_tb;
    reg flush_tb;

    // ----------------------------
    // DUT Instantiation
    // ----------------------------
    WriteBackSubsystem dut(
        .clk(clk),
        .rst_n(rst_n),

        .ra1_i(ra1_tb),
        .ra2_i(ra2_tb),
        .rd1_o(rd1_o_tb),
        .rd2_o(rd2_o_tb),

        .issue_i(issue_tb),
        .wa_arch_dispatch_i(wa_arch_dispatch_tb),
        .rob_id_o(rob_id_o_tb),
        .issue_ready_o(issue_ready_o_tb),

        .complete_ooc_i(complete_ooc_tb),
        .rob_id_complete_i(rob_id_complete_tb),
        .result_complete_i(result_complete_tb),

        .stall_pipeline_i(stall_tb),
        .flush_i(flush_tb)
    );

    // ----------------------------
    // Clock Generation
    // ----------------------------
    initial begin
        clk = 0;
        forever #5 clk = ~clk;      // 10 ns period
    end

    // ----------------------------
    // Helper Storage
    // ----------------------------
    reg [4:0] issued_ids [0:15];
    integer issued_ptr = 0;

    // ----------------------------
    // TASK: ISSUE Instruction
    // ----------------------------
    task issue_instr(input [4:0] dest, output [4:0] out_robid);
    begin
        @(posedge clk);
        issue_tb <= 1;
        wa_arch_dispatch_tb <= dest;

        @(posedge clk);
        issue_tb <= 0;
        wa_arch_dispatch_tb <= 0;

        out_robid = rob_id_o_tb;
        $display("T=%0t | ISSUE dest=%0d  -> ROB=%0d", $time, dest, out_robid);
    end
    endtask

    // ----------------------------
    // TASK: COMPLETE Instruction
    // ----------------------------
    task complete_instr(input [4:0] robid, input [31:0] value);
    begin
        @(posedge clk);
        complete_ooc_tb <= 1;
        rob_id_complete_tb <= robid;
        result_complete_tb <= value;

        @(posedge clk);
        complete_ooc_tb <= 0;
        rob_id_complete_tb <= 0;
        result_complete_tb <= 0;

        $display("T=%0t | COMPLETE ROB=%0d  value=%0d", $time, robid, value);
    end
    endtask

    // =====================================================================================
    // MAIN TEST
    // =====================================================================================
    reg [4:0] id_old, id_young;
    reg [4:0] id3, id4, id5, id6;

    initial begin
        issue_tb = 0;
        complete_ooc_tb = 0;
        stall_tb = 0;
        flush_tb = 0;

        ra1_tb = 0;
        ra2_tb = 0;

        rst_n = 0;
        #17 rst_n = 1;
        @(posedge clk);

        $display("\n=== TEST START ===");

        // =========================================================================
        // SCENARIO 1:
        // Out-of-order completion but IN-ORDER commit
        // =========================================================================
        issue_instr(5, id_old);     // I1
        issue_instr(6, id_young);   // I2

        complete_instr(id_young, 32'd6000);   // I2 completes first
        complete_instr(id_old,   32'd5000);   // I1 completes later

        // Wait a few cycles for commit
        @(posedge clk); @(posedge clk);

        ra1_tb = 5;
        @(posedge clk);

        if (rd1_o_tb == 5000)
            $display("PASS: Scenario 1: In-order commit works (R5=5000)");
        else
            $display("FAIL: Scenario 1: Expected R5=5000, got %0d", rd1_o_tb);

        // =========================================================================
        // SCENARIO 2:
        // WAW Hazard (younger overwrites older)
        // =========================================================================
        issue_instr(7, id3);   // older
        issue_instr(7, id4);   // younger

        complete_instr(id4, 9000);   // younger finishes first
        complete_instr(id3, 500);    // older finishes last

        @(posedge clk); @(posedge clk);

        ra1_tb = 7;
        @(posedge clk);

        if (rd1_o_tb == 9000)
            $display("PASS: Scenario 2: WAW resolved correctly (R7=9000)");
        else
            $display("FAIL: Scenario 2: Expected R7=9000, got %0d", rd1_o_tb);

        // =========================================================================
        // SCENARIO 3:
        // Stall commit then resume
        // =========================================================================
        issue_instr(8, id5);
        complete_instr(id5, 8888);

        @(posedge clk);
        stall_tb = 1;

        @(posedge clk); @(posedge clk);

        ra1_tb = 8;
        @(posedge clk);
        $display("During stall, R8=%0d (should NOT be 8888 yet)", rd1_o_tb);

        stall_tb = 0;

        @(posedge clk); @(posedge clk);

        if (rd1_o_tb == 8888)
            $display("PASS: Scenario 3: Commit after stall OK (R8=8888)");
        else
            $display("FAIL: Scenario 3: Expected R8=8888, got %0d", rd1_o_tb);

        // =========================================================================
        // SCENARIO 4:
        // ROB Full + blocking + flush
        // =========================================================================
        issue_instr(1, id6);
        issue_instr(2, id6);
        issue_instr(3, id6);
        issue_instr(4, id6);

        @(posedge clk);

        if (issue_ready_o_tb == 0)
            $display("PASS: Scenario 4: ROB full blocks issue");
        else
            $display("FAIL: Scenario 4: ROB full did not block issue");

        @(posedge clk);
        flush_tb = 1;

        @(posedge clk);
        flush_tb = 0;

        @(posedge clk);

        if (issue_ready_o_tb == 1)
            $display("PASS: Scenario 4: Flush cleared ROB (issue_ready=1)");
        else
            $display("FAIL: Scenario 4: ROB not cleared after flush");

        $display("\n=== TEST COMPLETE ===");
        #20 $finish;
    end

endmodule



